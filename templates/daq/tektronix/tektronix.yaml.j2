ioc_name: {{iocname}}
description:  Tektronics TEMPLATE

entities:

- type: tektronix.{{devtype}}
  name: TEKTRONIX-{{server}}
  IP: {{server}}
  TCPPORT: {{port |default(4000)}}
  P: "{{iocprefix}}"
{%- if devtype == "mso58lp-asyn" %}
  NUM_CHANNELS: {{num_channels | default(4)}}
  NUM_MEASUREMENTS: {{num_measurements | default(4)}}
  SAMPLES: {{samples | default(10000)}}
  POLL_TIME: {{poll_time | default(0.1)}}
  CA_MAX_ARRAY_BYTES: {{ca_max_array_bytes | default(3000000)}}
{%- else %}
  SAMPLES: {{samples | default(10000)}}
{%- endif %}


{%- for t in devices %}
{#- ============================================================ #}
{#- ASYN Driver Mode (mso58lp-asyn)                              #}
{#- ============================================================ #}
{%- if devtype == "mso58lp-asyn" %}

{#- ASYN measurement mode #}
{% if t.devtype is defined and t.devtype == "measurement" %}
- type: tektronix.measurement-asyn
  ctrl: TEKTRONIX-{{server}}
  meas: {{t.meas | default(t.channel)}}
  channel: {{t.channel}}
  name: {{t.name}}
  type: {{t.type if t.type is defined else "MEAN"}}
  enable: {{t.enable if t.enable is defined else 1}}
  coeff: {{t.coeff if t.coeff is defined else "1.0"}}
  EGU: {{t.egu if t.egu is defined else "pC"}}
- type: epics.DbAlias
  name: "{{iocprefix}}:MEAS{{t.meas | default(t.channel)}}:Value"
  alias: "{{iocprefix}}:{{t.name}}:VALUE"
- type: epics.DbAlias
  name: "{{iocprefix}}:MEAS{{t.meas | default(t.channel)}}:Mean"
  alias: "{{iocprefix}}:{{t.name}}:MEAN"

{#- ASYN channel with waveform acquisition (default for asyn) #}
{%- else %}
- type: tektronix.channel-asyn
  ctrl: TEKTRONIX-{{server}}
  channel: {{t.channel}}
  {% if t.samples is defined %}
  samples: {{t.samples}}
  {% else %}
  samples: {{samples if samples is defined else 10000}}
  {% endif %}
  name: {{t.name}}
  coeff: {{t.coeff if t.coeff is defined else "1.0"}}
  CHARGE_EGU: {{t.charge_egu if t.charge_egu is defined else "pC"}}

- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Waveform"
  alias: "{{iocprefix}}:{{t.name}}:WAVEFORM"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:TimeArray"
  alias: "{{iocprefix}}:{{t.name}}:TIMEARRAY"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Integral"
  alias: "{{iocprefix}}:{{t.name}}:INTEGRAL"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:RMS"
  alias: "{{iocprefix}}:{{t.name}}:RMS"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Mean"
  alias: "{{iocprefix}}:{{t.name}}:MEAN"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Min"
  alias: "{{iocprefix}}:{{t.name}}:MIN"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Max"
  alias: "{{iocprefix}}:{{t.name}}:MAX"
- type: epics.DbAlias
  name: "{{iocprefix}}:CH{{t.channel}}:Charge"
  alias: "{{iocprefix}}:{{t.name}}:CHARGE"
{%- endif %}

{#- ============================================================ #}
{#- StreamDevice Mode (mso58lp)                                  #}
{#- ============================================================ #}
{%- else %}

{#- StreamDevice measurement mode #}
{% if t.devtype is defined and t.devtype == "measurement" %}
- type: tektronix.measurement
  ctrl: TEKTRONIX-{{server}}
  channel: {{t.channel}}
  name: {{t.name}}
  coeff: {{t.coeff if t.coeff is defined else "1.0"}}
  rate: {{t.rate if t.rate is defined else ".1 second"}}
  EGU: {{t.egu if t.egu is defined else "pC"}}
  ENABLEPV: "{{t.enablepv if t.enablepv is defined else 1}}"
- type: epics.DbAlias
  name: "{{iocprefix}}:CHARGE_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:CHARGE"
- type: epics.DbAlias
  name: "{{iocprefix}}:CHARGE_DAY_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:CHARGE_DAY"

{#- StreamDevice channel with waveform (default) #}
{%- else %}
- type: tektronix.channel
  ctrl: TEKTRONIX-{{server}}
  channel: {{t.channel}}
  {% if t.samples is defined %}
  samples: {{t.samples}}
  {% else %}
  samples: {{samples if samples is defined else 10000}}
  {% endif %}
  name: {{t.name}}
  coeff: {{t.coeff if t.coeff is defined else "1.0"}}
  rate: {{t.rate if t.rate is defined else "1 second"}}

- type: epics.DbAlias
  name: "{{iocprefix}}:INTEGRAL_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:INTEGRAL"
- type: epics.DbAlias
  name: "{{iocprefix}}:RMS_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:RMS"

- type: epics.DbAlias
  name: "{{iocprefix}}:MEAN_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:MEAN"

- type: epics.DbAlias
  name: "{{iocprefix}}:MIN_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:MIN"
- type: epics.DbAlias
  name: "{{iocprefix}}:MAX_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:MAX"

- type: epics.DbAlias
  name: "{{iocprefix}}:CHARGE_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:CHARGE"
- type: epics.DbAlias
  name: "{{iocprefix}}:CHARGE_DAY_CH{{t.channel}}"
  alias: "{{iocprefix}}:{{t.name}}:CHARGE_DAY"
{%- endif %}
{%- endif %}
{%- endfor %}

- type: epics.PostStartupCommand 
  command: |
  {%- for param in iocinit %}
  dbpf ("{{iocprefix}}:{{param.name}}","{{param.value}}")
  {%- endfor %}
  {%- for dev in devices %}
  {%- for param in dev.iocinit %}
  dbpf ("{{iocprefix}}:{{dev.name}}:{{param.name}}","{{param.value}}")
  {%- endfor %}
  {%- endfor %}
  {%- if iocexit %}
      dbl
      exit
  {%- else %}
      dbl("*") > {{config_dir}}/pvlist.txt           ## dumps PV NAMES
      dbl
  {%- endif %}