ioc_name: {{iocname}}
description: HAZEMEYER TEMPLATE

entities:
{%- if devtype == "haz-ser" %}
# ============================================================================
# SERIAL MODE - Modbus RTU via Serial-to-Ethernet converter
# ============================================================================
- type: hazemeyer.serial
  IP: {{server}}
  TCPPORT: {{port}}
  P: "{{iocprefix}}"
  NAME: "HAZEMEYER001"
  TIMEOUT: {{ timeout if timeout is defined else 1000 }}
  WDELAY: {{ wdelay if wdelay is defined else 200 }}

{%- for t in devices %}
- type: hazemeyer.ps
  serctrl: "HAZEMEYER001"
  R: "{{t.name}}"
  VMAX: {{ t.vmax if t.vmax is defined else 110 }}
  IMAX: {{ t.imax if t.imax is defined else 200 }}
  ID: {{ t.id}}
  WPOLL: {{ t.wpoll if t.wpoll is defined else 200 }}
  RPOLL: {{ t.rpoll if t.rpoll is defined else 2000 }}
{%- endfor %}

{%- elif devtype == "haz-iocast" %}
# ============================================================================
# TCP/IP IOCAST MODE - Direct Modbus TCP connection per device
# ============================================================================
{%- for t in devices %}
- type: hazemeyer.tcp_iocast
  IP: {{ t.ip }}
  TCPPORT: {{ port if port is defined else 502 }}
  P: "{{ iocprefix }}"
  NAME: "HAZEMEYER_TCP_{{ t.name }}"

- type: hazemeyer.ps_iocast
  tcpctrl: "HAZEMEYER_TCP_{{ t.name }}"
  R: "{{ t.name }}"
  POLL: {{ t.poll if t.poll is defined else 1000 }}
  TIMEOUT: {{ t.timeout if t.timeout is defined else 2000 }}
{%- endfor %}

{%- endif %}

# ============================================================================
# POST-STARTUP COMMANDS
# ============================================================================

# --- Aliases (currently disabled) ---
# - type: epics.StartupCommand
#   command: |
#     echo "Starting {{iocname}} IOC"
#     {%- for dev in devices %}
#     {%- for param in dev.aliases %}
#     alias("{{iocprefix}}:{{dev.name}}:{{param.name}}","{{param.alias}}")
#     {%- endfor %}
#     {%- endfor %}

# --- Initialize PV values ---
- type: epics.PostStartupCommand
  command: |
  {%- for param in iocinit %}
    dbpf("{{iocprefix}}:{{iocroot}}:{{param.name}}", "{{param.value}}")
  {%- endfor %}
  {%- for dev in devices %}
  {%- for param in dev.iocinit %}
    dbpf("{{iocprefix}}:{{dev.name}}:{{param.name}}", "{{param.value}}")
  {%- endfor %}
  {%- endfor %}
  {%- if iocexit %}
    dbl
    exit
  {%- else %}
    dbl("*") > {{config_dir}}/pvlist.txt
    dbl
  {%- endif %}